<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HD Pro-Vision: Safe Mode</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Oswald:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root { --hd-orange: #F96302; --hd-dark: #111; --hd-light: #f0f0f0; --hd-grey: #e0e0e0; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Roboto', sans-serif; background: var(--hd-light); color: #333; overflow-x: hidden; }
        
        header { background: var(--hd-dark); padding: 15px 20px; color: white; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .logo-group { display: flex; align-items: center; gap: 12px; }
        .hd-square { background: var(--hd-orange); color: white; font-family: 'Oswald', sans-serif; font-size: 0.75rem; font-weight: bold; padding: 5px 8px; line-height: 1; transform: skew(-10deg); }
        header h1 { font-family: 'Oswald', sans-serif; margin: 0; font-size: 1.3rem; }

        /* By default, show the home page so it never stays blank */
        .page { display: none; max-width: 550px; margin: 0 auto; padding: 20px; }
        #homePage { display: block; } /* Forced block for safety */
        .active { display: block !important; }

        .card { background: white; border-radius: 16px; padding: 24px; box-shadow: 0 8px 24px rgba(0,0,0,0.06); margin-bottom: 20px; }
        .btn { width: 100%; padding: 16px; border: none; border-radius: 8px; font-family: 'Roboto', sans-serif; font-weight: 700; font-size: 1rem; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px; text-transform: uppercase; }
        .btn-orange { background: var(--hd-orange); color: white; }
        .btn-dark { background: #333; color: white; }

        .viewport { position: relative; width: 100%; border-radius: 12px; overflow: hidden; background: #000; min-height: 300px; }
        canvas { width: 100%; display: block; }
        video { display: none; }
        
        .swatch-box { display: flex; gap: 12px; overflow-x: auto; padding: 10px 0; }
        .swatch { width: 50px; height: 50px; border-radius: 50%; border: 4px solid white; cursor: pointer; flex-shrink: 0; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .swatch.selected { border-color: var(--hd-orange); transform: scale(1.1); }

        /* ON-SCREEN ERROR CATCHER */
        #errorBox { display: none; background: #ffebee; color: #c62828; padding: 15px; margin: 20px; border-left: 5px solid #c62828; font-family: monospace; font-size: 0.85rem; border-radius: 4px; word-wrap: break-word; }
    </style>
</head>
<body>

<header>
    <div class="logo-group">
        <div class="hd-square">THE<br>HOME<br>DEPOT</div>
        <h1>Pro-Vision</h1>
    </div>
</header>

<div id="errorBox"></div>

<div id="homePage" class="page">
    <div class="card">
        <h2 style="margin-top:0;">Start a Room</h2>
        <p style="color: #666; font-size: 0.95rem;">Tap below to select a video from your camera roll.</p>
        <input type="file" id="videoCapture" accept="video/*" style="display:none" onchange="loadVideo(event)">
        <button class="btn btn-orange" onclick="document.getElementById('videoCapture').click()">
            <span>ðŸ“·</span> Upload Video
        </button>
    </div>
</div>

<div id="editorPage" class="page">
    <div class="viewport" id="vp">
        <video id="vSource" loop muted playsinline></video>
        <canvas id="cOutput" onclick="targetWall(event)"></canvas>
        <div id="targetText" style="position:absolute; top:50%; left:0; width:100%; text-align:center; color:white; font-family:'Oswald'; font-size:1.2rem; pointer-events:none;">TAP THE WALL TO MESH</div>
    </div>
    
    <div class="card" style="margin-top:20px;">
        <label style="font-weight: bold; font-size: 0.85rem; color:#555;">AI SENSITIVITY</label>
        <input type="range" id="sens" min="10" max="90" value="40" style="width:100%; accent-color:var(--hd-orange); margin-bottom:15px;">
        <div class="swatch-box" id="palette"></div>
    </div>

    <button class="btn btn-dark" onclick="location.reload()">Back to Start</button>
</div>

<script>
    // --- ON-SCREEN ERROR CATCHER ---
    window.onerror = function(message, source, lineno, colno, error) {
        document.getElementById('errorBox').style.display = 'block';
        document.getElementById('errorBox').innerText = "CRASH LOG: " + message + " (Line: " + lineno + ")";
        return true; 
    };

    // Safely wrap everything so it waits for the page to exist
    window.addEventListener('DOMContentLoaded', (event) => {
        const paintList = [
            { n: 'White', h: '#FFFFFF' }, { n: 'Gray', h: '#D1CBC1' },
            { n: 'Blue', h: '#202A44' }, { n: 'Green', h: '#384B3E' },
            { n: 'Red', h: '#B55A44' }, { n: 'Gold', h: '#D8A728' }
        ];

        let selectedPaint = null;
        let wallTarget = null;
        let loop;
        
        const v = document.getElementById('vSource');
        const c = document.getElementById('cOutput');
        // Removed 'willReadFrequently' as some older mobile browsers crash on it
        const ctx = c.getContext('2d'); 

        window.loadVideo = function(e) {
            try {
                const file = e.target.files[0];
                if(!file) return;
                
                // Safely create the video URL
                const url = URL.createObjectURL(file);
                v.src = url;
                
                document.getElementById('homePage').style.display = 'none';
                document.getElementById('editorPage').classList.add('active');
                
                v.play().catch(err => {
                    throw new Error("Browser blocked video playback: " + err.message);
                });

                v.onloadedmetadata = () => {
                    c.width = v.videoWidth || 300;
                    c.height = v.videoHeight || 400;
                    startEngine();
                };
            } catch (err) {
                document.getElementById('errorBox').style.display = 'block';
                document.getElementById('errorBox').innerText = "VIDEO LOAD ERROR: " + err.message;
            }
        };

        window.targetWall = function(e) {
            const rect = c.getBoundingClientRect();
            const x = (e.clientX - rect.left) * (c.width / rect.width);
            const y = (e.clientY - rect.top) * (c.height / rect.height);
            const p = ctx.getImageData(x, y, 1, 1).data;
            wallTarget = {r: p[0], g: p[1], b: p[2]};
            document.getElementById('targetText').style.display = 'none';
        };

        function startEngine() {
            if (v.paused || v.ended) return;
            ctx.drawImage(v, 0, 0, c.width, c.height);
            
            if (wallTarget && selectedPaint) {
                const frame = ctx.getImageData(0, 0, c.width, c.height);
                const d = frame.data;
                const sens = document.getElementById('sens').value;

                for (let i = 0; i < d.length; i += 4) {
                    const r = d[i], g = d[i+1], b = d[i+2];
                    const diff = Math.sqrt(Math.pow(r-wallTarget.r,2)+Math.pow(g-wallTarget.g,2)+Math.pow(b-wallTarget.b,2));

                    if (diff < sens) {
                        d[i] = (r * selectedPaint.r) / 255;
                        d[i+1] = (g * selectedPaint.g) / 255;
                        d[i+2] = (b * selectedPaint.b) / 255;
                    }
                }
                ctx.putImageData(frame, 0, 0);
            }
            loop = requestAnimationFrame(startEngine);
        }

        // Initialize Palette safely
        const palette = document.getElementById('palette');
        paintList.forEach(p => {
            const s = document.createElement('div');
            s.className = 'swatch';
            s.style.background = p.h;
            s.onclick = () => {
                selectedPaint = {
                    r: parseInt(p.h.slice(1,3), 16),
                    g: parseInt(p.h.slice(3,5), 16),
                    b: parseInt(p.h.slice(5,7), 16)
                };
                document.querySelectorAll('.swatch').forEach(el => el.classList.remove('selected'));
                s.classList.add('selected');
            };
            palette.appendChild(s);
        });
    });
</script>
</body>
</html>
