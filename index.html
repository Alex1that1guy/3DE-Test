<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Depot Pro Vision</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Oswald:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root { --hd-orange: #F96302; --hd-dark: #333333; --hd-light: #f5f5f5; }
        * { box-sizing: border-box; touch-action: manipulation; }
        body { margin: 0; font-family: 'Roboto', sans-serif; background: var(--hd-light); color: #333; text-align: center; }
        
        header { background: var(--hd-orange); padding: 12px; color: white; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .hd-square { background: var(--hd-orange); border: 2px solid white; color: white; font-family: 'Oswald', sans-serif; font-size: 0.7rem; font-weight: bold; padding: 3px 5px; line-height: 1; transform: skew(-10deg); }
        h1 { font-family: 'Oswald', sans-serif; margin: 0; font-size: 1.3rem; letter-spacing: 0.5px; text-transform: uppercase; }

        .page { display: none; max-width: 450px; margin: 0 auto; padding: 20px; min-height: 100vh; }
        .active { display: block; }

        .btn { width: 100%; padding: 16px; border: none; border-radius: 4px; font-family: 'Oswald', sans-serif; font-size: 1.1rem; cursor: pointer; margin-bottom: 12px; text-transform: uppercase; transition: 0.2s; }
        .btn-orange { background: var(--hd-orange); color: white; }
        .btn-dark { background: var(--hd-dark); color: white; }
        .btn-download { background: #2ecc71; color: white; }

        .viewport { position: relative; width: 100%; background: black; border-radius: 8px; overflow: hidden; border: 4px solid var(--hd-orange); }
        video { width: 100%; display: none; }
        canvas { width: 100%; display: block; }

        .list-card { background: white; padding: 15px; margin-bottom: 15px; border-left: 6px solid var(--hd-orange); text-align: left; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin: 20px 0; background: white; padding: 10px; border-radius: 8px; }
        .swatch { height: 45px; border-radius: 4px; cursor: pointer; border: 1px solid #ccc; }
        .swatch.selected { border: 3px solid var(--hd-orange); transform: scale(1.1); }
        
        .status-pill { background: #333; color:white; padding: 8px 15px; border-radius: 4px; font-size: 0.8rem; margin-bottom: 10px; display: inline-block; font-family: 'Oswald'; }
        .controls { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; text-align: left; }
        input[type=range] { width: 100%; accent-color: var(--hd-orange); margin-top: 5px; }
    </style>
</head>
<body>

    <header>
        <div class="hd-square">THE<br>HOME<br>DEPOT</div>
        <h1>Project Colorâ„¢</h1>
    </header>

    <div id="homePage" class="page active">
        <h2 style="font-family:'Oswald'; margin-top:30px;">Visualizer Dashboard</h2>
        <button class="btn btn-orange" onclick="showPage('uploadPage')">ðŸ“¹ New Room Scan</button>
        <button class="btn btn-dark" onclick="openStorage()">ðŸ“¦ My Projects</button>
    </div>

    <div id="uploadPage" class="page">
        <h2 style="font-family:'Oswald'">Record Video</h2>
        <p>Ensure the wall is clearly visible and recording is at least 3 seconds.</p>
        <input type="file" id="fileInput" accept="video/*" capture="environment" style="display:none" onchange="saveToStorage(event)">
        <button class="btn btn-orange" onclick="document.getElementById('fileInput').click()">Capture Video</button>
        <button class="btn btn-dark" onclick="showPage('homePage')">Back</button>
    </div>

    <div id="storagePage" class="page">
        <h2 style="font-family:'Oswald'">Project Library</h2>
        <div id="storageList"></div>
        <button class="btn btn-dark" onclick="showPage('homePage')">Main Menu</button>
    </div>

    <div id="editPage" class="page">
        <div class="status-pill" id="status">1. TAP THE WALL TO TARGET</div>
        
        <div class="viewport" onclick="setTarget(event)">
            <video id="sourceVid" loop muted playsinline crossorigin="anonymous"></video>
            <canvas id="outputCanvas"></canvas>
            <div style="position:absolute; bottom:10px; right:10px; pointer-events:none;">
                <div class="hd-square">THE<br>HOME<br>DEPOT</div>
            </div>
        </div>

        <div class="controls">
            <label style="font-weight:bold; font-size:0.8rem;">AI MATCH SENSITIVITY</label>
            <input type="range" id="sens" min="5" max="100" value="30">
        </div>

        <div class="grid" id="colorGrid"></div>
        
        <button class="btn btn-download" onclick="downloadImage()">ðŸ“¸ Save Photo to Device</button>
        <button class="btn btn-dark" onclick="stopEditor()">Close Editor</button>
    </div>

    <script>
        const paints = [
            {n:'Pure White', h:'#FFFFFF'}, {n:'Swiss Coffee', h:'#F1EFE0'},
            {n:'Slate Grey', h:'#708090'}, {n:'Naval Blue', h:'#202A44'},
            {n:'Sage Green', h:'#778875'}, {n:'Cinnamon', h:'#9E4825'},
            {n:'Harvest Gold', h:'#D8A728'}, {n:'Terra Cotta', h:'#C46247'},
            {n:'Teal Blue', h:'#006D75'}, {n:'Charcoal', h:'#333333'}
        ];

        let activeRGB = null; 
        let wallTargetHSL = null;
        let frameId;
        const video = document.getElementById('sourceVid');
        const canvas = document.getElementById('outputCanvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });

        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // --- STORAGE LOGIC ---
        function saveToStorage(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = () => {
                let db = JSON.parse(localStorage.getItem('hd_v4_storage') || '[]');
                db.push({id: Date.now(), data: reader.result});
                localStorage.setItem('hd_v4_storage', JSON.stringify(db));
                openStorage();
            };
            reader.readAsDataURL(file);
        }

        function openStorage() {
            const list = document.getElementById('storageList');
            list.innerHTML = "";
            let db = JSON.parse(localStorage.getItem('hd_v4_storage') || '[]');
            if(db.length === 0) list.innerHTML = "<p>No project videos found.</p>";
            db.forEach(item => {
                const card = document.createElement('div');
                card.className = "list-card";
                card.innerHTML = `
                    <strong>Scan: ${new Date(item.id).toLocaleTimeString()}</strong>
                    <video src="${item.data}" style="width:100%; border-radius:4px; margin-top:8px;"></video>
                    <button class="btn btn-orange" style="margin-top:8px; padding:10px;" onclick="initEditor('${item.data}')">Open Visualizer</button>
                    <button style="color:red; background:none; border:none; width:100%; padding:5px; cursor:pointer;" onclick="deleteProj(${item.id})">Delete</button>
                `;
                list.appendChild(card);
            });
            showPage('storagePage');
        }

        function deleteProj(id) {
            let db = JSON.parse(localStorage.getItem('hd_v4_storage') || '[]');
            localStorage.setItem('hd_v4_storage', JSON.stringify(db.filter(i => i.id !== id)));
            openStorage();
        }

        // --- AI LOGIC ---
        function initEditor(src) {
            video.src = src;
            wallTargetHSL = null; activeRGB = null;
            document.getElementById('status').innerText = "1. TAP THE WALL TO TARGET";
            showPage('editPage');
            video.play();
            video.onloadedmetadata = () => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                loop();
            };
        }

        // Convert RGB to HSL for better "Wall vs Person" detection
        function rgbToHsl(r, g, b) {
            r /= 255; g /= 255; b /= 255;
            const max = Math.max(r, g, b), min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;
            if (max === min) { h = s = 0; } 
            else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch (max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                h /= 6;
            }
            return [h * 360, s * 100, l * 100];
        }

        function setTarget(e) {
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) * (canvas.width / rect.width);
            const y = (e.clientY - rect.top) * (canvas.height / rect.height);
            const p = ctx.getImageData(x, y, 1, 1).data;
            wallTargetHSL = rgbToHsl(p[0], p[1], p[2]);
            document.getElementById('status').innerText = "2. PICK A COLOR BELOW";
        }

        function loop() {
            if (video.paused || video.ended) return;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const frame = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = frame.data;
            const sens = document.getElementById('sens').value;

            if (wallTargetHSL && activeRGB) {
                for (let i = 0; i < data.length; i += 4) {
                    const hsl = rgbToHsl(data[i], data[i+1], data[i+2]);
                    
                    // Strong AI: Check if Hue and Saturation match the wall
                    const hueDiff = Math.abs(hsl[0] - wallTargetHSL[0]);
                    const satDiff = Math.abs(hsl[1] - wallTargetHSL[1]);
                    const lumDiff = Math.abs(hsl[2] - wallTargetHSL[2]);

                    // If it matches the tapped wall "signature"
                    if (hueDiff < sens && satDiff < sens && lumDiff < sens * 1.5) {
                        data[i] = (data[i] * activeRGB.r) / 255;
                        data[i+1] = (data[i+1] * activeRGB.g) / 255;
                        data[i+2] = (data[i+2] * activeRGB.b) / 255;
                    }
                }
            }
            ctx.putImageData(frame, 0, 0);
            frameId = requestAnimationFrame(loop);
        }

        // --- UI UTILS ---
        function initGrid() {
            const grid = document.getElementById('colorGrid');
            paints.forEach(p => {
                const sw = document.createElement('div');
                sw.className = 'swatch'; sw.style.background = p.h;
                sw.onclick = () => {
                    activeRGB = hexToRgb(p.h);
                    document.querySelectorAll('.swatch').forEach(s => s.classList.remove('selected'));
                    sw.classList.add('selected');
                };
                grid.appendChild(sw);
            });
        }

        function hexToRgb(hex) {
            const r = parseInt(hex.slice(1,3), 16), g = parseInt(hex.slice(3,5), 16), b = parseInt(hex.slice(5,7), 16);
            return {r, g, b};
        }

        function stopEditor() { cancelAnimationFrame(frameId); video.pause(); showPage('storagePage'); }

        function downloadImage() {
            const link = document.createElement('a');
            link.download = 'my-hd-project.png';
            link.href = canvas.toDataURL();
            link.click();
        }

        initGrid();
    </script>
</body>
</html>
