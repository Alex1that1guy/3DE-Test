<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Depot Pro Vision</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Oswald:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root { --hd-orange: #F96302; --hd-dark: #333333; --hd-light: #f5f5f5; }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Roboto', sans-serif; background: var(--hd-light); color: #333; text-align: center; }
        
        /* HEADER BRANDING */
        header { 
            background: var(--hd-orange); padding: 12px; color: white; 
            display: flex; align-items: center; justify-content: center; gap: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .hd-square { 
            background: var(--hd-orange); border: 2px solid white; color: white; 
            font-family: 'Oswald', sans-serif; font-size: 0.7rem; font-weight: bold; 
            padding: 3px 5px; line-height: 1; transform: skew(-10deg); 
        }
        h1 { font-family: 'Oswald', sans-serif; margin: 0; font-size: 1.3rem; letter-spacing: 0.5px; }

        .page { display: none; max-width: 450px; margin: 0 auto; padding: 20px; min-height: 100vh; }
        .active { display: block; }

        /* BUTTONS */
        .btn { width: 100%; padding: 16px; border: none; border-radius: 4px; font-family: 'Oswald', sans-serif; font-size: 1.1rem; cursor: pointer; margin-bottom: 12px; text-transform: uppercase; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn-orange { background: var(--hd-orange); color: white; }
        .btn-dark { background: var(--hd-dark); color: white; }
        .btn-outline { background: white; border: 2px solid var(--hd-orange); color: var(--hd-orange); }

        /* SCANNER UI */
        .viewport { position: relative; width: 100%; background: black; border-radius: 8px; overflow: hidden; border: 4px solid var(--hd-orange); }
        video { width: 100%; display: none; }
        canvas { width: 100%; display: block; }
        
        /* High-End Scanning Animation */
        .scan-line {
            position: absolute; top: 0; left: 0; width: 100%; height: 4px;
            background: cyan; box-shadow: 0 0 10px cyan;
            animation: scan 2s infinite linear;
            display: none;
        }
        .scanning .scan-line { display: block; }
        @keyframes scan { 0% { top: 0%; } 100% { top: 100%; } }

        /* Color Grid */
        .grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin: 20px 0; background: white; padding: 10px; border-radius: 8px; }
        .swatch { height: 45px; border-radius: 4px; cursor: pointer; border: 1px solid #ccc; position: relative; }
        .swatch.selected { border: 3px solid var(--hd-orange); transform: scale(1.1); z-index: 2; }
        
        .pill { background: #eee; padding: 5px 15px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; margin-bottom: 10px; display: inline-block; }
    </style>
</head>
<body>

    <header>
        <div class="hd-square">THE<br>HOME<br>DEPOT</div>
        <h1>Project Colorâ„¢</h1>
    </header>

    <div id="homePage" class="page active">
        <h2 style="font-family:'Oswald'; margin-top:30px;">Visualizer Tools</h2>
        <button class="btn btn-orange" onclick="showPage('camPage')">ðŸ“· Start New Scan</button>
        <button class="btn btn-dark" onclick="openStorage()">ðŸ“¦ My Projects</button>
        <button class="btn btn-outline" onclick="showPage('palettePage')">ðŸŽ¨ Color Palette</button>
    </div>

    <div id="camPage" class="page">
        <h2 style="font-family:'Oswald'">Capture Room</h2>
        <div style="background:white; padding:15px; border-radius:8px; margin-bottom:20px; text-align:left;">
            <strong>Instructions:</strong>
            <ul style="padding-left:20px; margin-top:5px; font-size:0.9rem; color:#555;">
                <li>Hold camera steady.</li>
                <li>Ensure walls are well lit.</li>
                <li>Record for 3 seconds.</li>
            </ul>
        </div>
        <input type="file" id="fileIn" accept="video/*" capture="environment" style="display:none" onchange="handleUpload(event)">
        <button class="btn btn-orange" onclick="document.getElementById('fileIn').click()">Record Video</button>
        <button class="btn btn-dark" onclick="showPage('homePage')">Back</button>
    </div>

    <div id="storagePage" class="page">
        <h2 style="font-family:'Oswald'">Saved Projects</h2>
        <div id="storageList"></div>
        <button class="btn btn-dark" onclick="showPage('homePage')">Main Menu</button>
    </div>

    <div id="palettePage" class="page">
        <h2 style="font-family:'Oswald'">BehrÂ® Premium Plus</h2>
        <div class="grid" id="paletteGrid"></div>
        <button class="btn btn-dark" onclick="showPage('homePage')">Back</button>
    </div>

    <div id="editorPage" class="page">
        <div class="pill" id="status">AI: ANALYZING DEPTH...</div>
        
        <div class="viewport" id="viewport">
            <div class="scan-line"></div>
            <video id="vid" loop muted playsinline></video>
            <canvas id="canv"></canvas>
            <div style="position:absolute; bottom:10px; right:10px; opacity:0.8;">
                <div class="hd-square">THE<br>HOME<br>DEPOT</div>
            </div>
        </div>

        <div class="grid" id="editorGrid"></div>
        
        <div style="display:flex; gap:10px;">
            <button class="btn btn-orange" onclick="saveProject()">Save</button>
            <button class="btn btn-dark" onclick="stopAI()">Exit</button>
        </div>
    </div>

    <script>
        const colors = [
            {n:'Ultra Pure White', h:'#FFFFFF'}, {n:'Swiss Coffee', h:'#F1EFE0'},
            {n:'Polar Bear', h:'#F5F6F0'}, {n:'Slate Grey', h:'#708090'},
            {n:'Naval', h:'#202A44'}, {n:'Sage', h:'#778875'},
            {n:'Cinnamon', h:'#9E4825'}, {n:'Mustard', h:'#D8A728'},
            {n:'Terracotta', h:'#C46247'}, {n:'Teal', h:'#006D75'}
        ];

        let activeColor = null; 
        let animID;
        const video = document.getElementById('vid');
        const canvas = document.getElementById('canv');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });

        // --- NAVIGATION & STORAGE ---
        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function handleUpload(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = () => {
                let s = JSON.parse(localStorage.getItem('hd_pro') || '[]');
                s.push({id: Date.now(), data: reader.result});
                localStorage.setItem('hd_pro', JSON.stringify(s));
                openStorage();
            };
            reader.readAsDataURL(file);
        }

        function openStorage() {
            const list = document.getElementById('storageList');
            list.innerHTML = "";
            let s = JSON.parse(localStorage.getItem('hd_pro') || '[]');
            s.forEach(item => {
                const d = document.createElement('div');
                d.style.background = "white"; d.style.padding = "10px"; d.style.marginBottom = "10px"; d.style.borderRadius="4px";
                d.innerHTML = `<video src="${item.data}" style="width:100%; border-radius:4px"></video>
                               <button class="btn btn-orange" style="margin:5px 0 0 0; padding:10px;" onclick="startAI('${item.data}')">OPEN PROJECT</button>`;
                list.appendChild(d);
            });
            showPage('storagePage');
        }

        // --- COLOR INIT ---
        function initColors() {
            const pGrid = document.getElementById('paletteGrid');
            const eGrid = document.getElementById('editorGrid');
            colors.forEach(c => {
                const d = document.createElement('div');
                d.className = 'swatch'; d.style.background = c.h;
                d.onclick = () => { 
                    activeColor = hexToRgb(c.h); 
                    document.getElementById('status').innerText = "APPLIED: " + c.n.toUpperCase();
                    document.getElementById('viewport').classList.remove('scanning');
                    document.querySelectorAll('.swatch').forEach(s => s.classList.remove('selected'));
                    d.classList.add('selected');
                };
                pGrid.appendChild(d.cloneNode(true));
                eGrid.appendChild(d); // Note: Cloning logic simplified for demo
                // Re-attach event for editor grid
                const eItem = eGrid.lastChild;
                eItem.onclick = () => {
                    activeColor = hexToRgb(c.h);
                    document.getElementById('status').innerText = "APPLIED: " + c.n.toUpperCase();
                    document.getElementById('viewport').classList.remove('scanning');
                    document.querySelectorAll('.swatch').forEach(s => s.classList.remove('selected'));
                    eItem.classList.add('selected');
                }
            });
        }

        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : null;
        }

        // --- THE STRONG AI ENGINE ---
        function startAI(src) {
            video.src = src;
            activeColor = null;
            document.getElementById('status').innerText = "AI: SCANNING FOR WALLS...";
            document.getElementById('viewport').classList.add('scanning');
            showPage('editorPage');
            video.play();
            video.onloadedmetadata = () => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                processLoop();
            };
        }

        function processLoop() {
            if (video.paused || video.ended) return;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const frame = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = frame.data;

            // Highlight Pulse Variable
            const pulse = (Math.sin(Date.now() / 100) + 1) / 2; 

            for (let i = 0; i < data.length; i += 4) {
                const r = data[i], g = data[i+1], b = data[i+2];

                // 1. ADVANCED WHITE DETECTION (HSL Logic)
                const max = Math.max(r, g, b);
                const min = Math.min(r, g, b);
                const l = (max + min) / 2; // Lightness
                const d = max - min; // Chroma (Saturation roughly)

                // Detect "Wall-Like" pixels
                // Low saturation (d < 30) = White, Grey, Beige, Cream
                // Medium Lightness (l > 60) = Catches shadows, but not pitch black
                if (d < 30 && l > 60) {
                    
                    // 2. SOFT MASKING (The "Stronger" AI Part)
                    // Instead of ON/OFF, we calculate how "wall-like" it is
                    // This creates a smooth fade around edges and shadows
                    let intensity = 1.0;
                    if (l < 100) intensity = 0.6; // In shadows, paint is less intense
                    if (d > 20) intensity = 0.5;  // If slightly colorful, blend more

                    if (!activeColor) {
                        // SCANNING MODE: Cyan Highlight
                        data[i] = r + (0 - r) * 0.5 * pulse;
                        data[i+1] = g + (255 - g) * 0.5 * pulse;
                        data[i+2] = b + (255 - b) * 0.5 * pulse;
                    } else {
                        // PAINTING MODE: Soft Blend
                        // Original pixel * (1-intensity) + New Color * intensity
                        data[i] = (r * (1 - intensity)) + (activeColor.r * intensity);
                        data[i+1] = (g * (1 - intensity)) + (activeColor.g * intensity);
                        data[i+2] = (b * (1 - intensity)) + (activeColor.b * intensity);
                    }
                }
            }
            ctx.putImageData(frame, 0, 0);
            animID = requestAnimationFrame(processLoop);
        }

        function stopAI() {
            cancelAnimationFrame(animID);
            video.pause();
            showPage('storagePage');
        }

        function saveProject() { alert("Project Saved to Account!"); stopAI(); }

        initColors();
    </script>
</body>
</html>
