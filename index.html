<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Depot Pro Vision</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Oswald:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root { --hd-orange: #F96302; --hd-dark: #333333; --hd-light: #f5f5f5; }
        * { box-sizing: border-box; touch-action: manipulation; }
        body { margin: 0; font-family: 'Roboto', sans-serif; background: var(--hd-light); color: #333; text-align: center; }
        
        /* HEADER */
        header { 
            background: var(--hd-orange); padding: 12px; color: white; 
            display: flex; align-items: center; justify-content: center; gap: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .hd-square { 
            background: var(--hd-orange); border: 2px solid white; color: white; 
            font-family: 'Oswald', sans-serif; font-size: 0.7rem; font-weight: bold; 
            padding: 3px 5px; line-height: 1; transform: skew(-10deg); 
        }
        h1 { font-family: 'Oswald', sans-serif; margin: 0; font-size: 1.3rem; letter-spacing: 0.5px; }

        .page { display: none; max-width: 450px; margin: 0 auto; padding: 20px; min-height: 100vh; }
        .active { display: block; }

        /* BUTTONS */
        .btn { width: 100%; padding: 16px; border: none; border-radius: 4px; font-family: 'Oswald', sans-serif; font-size: 1.1rem; cursor: pointer; margin-bottom: 12px; text-transform: uppercase; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn-orange { background: var(--hd-orange); color: white; }
        .btn-dark { background: var(--hd-dark); color: white; }
        .btn-outline { background: white; border: 2px solid var(--hd-orange); color: var(--hd-orange); }

        /* VIEWP0RT */
        .viewport { position: relative; width: 100%; background: black; border-radius: 8px; overflow: hidden; border: 4px solid var(--hd-orange); touch-action: none; }
        video { width: 100%; display: none; }
        canvas { width: 100%; display: block; }

        /* CROSSHAIR INSTRUCTION */
        .tap-instruction {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.7); color: white; padding: 10px 20px; border-radius: 20px;
            font-weight: bold; pointer-events: none; opacity: 1; transition: opacity 0.5s;
        }

        /* PALETTE */
        .grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin: 20px 0; background: white; padding: 10px; border-radius: 8px; }
        .swatch { height: 45px; border-radius: 4px; cursor: pointer; border: 1px solid #ccc; }
        .swatch.selected { border: 3px solid var(--hd-orange); transform: scale(1.1); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        
        .pill { background: #333; color:white; padding: 8px 15px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; margin-bottom: 10px; display: inline-block; font-family: 'Oswald'; letter-spacing: 1px; }
        
        .slider-container { background: white; padding: 10px; margin-top: 10px; border-radius: 8px; }
        input[type=range] { width: 100%; accent-color: var(--hd-orange); }
    </style>
</head>
<body>

    <header>
        <div class="hd-square">THE<br>HOME<br>DEPOT</div>
        <h1>Project Colorâ„¢</h1>
    </header>

    <div id="homePage" class="page active">
        <h2 style="font-family:'Oswald'; margin-top:30px;">Visualizer Tools</h2>
        <button class="btn btn-orange" onclick="showPage('camPage')">ðŸ“· Start New Scan</button>
        <button class="btn btn-dark" onclick="openStorage()">ðŸ“¦ My Projects</button>
    </div>

    <div id="camPage" class="page">
        <h2 style="font-family:'Oswald'">Capture Room</h2>
        <p>Record a stable 3-second video of your room.</p>
        <input type="file" id="fileIn" accept="video/*" capture="environment" style="display:none" onchange="handleUpload(event)">
        <button class="btn btn-orange" onclick="document.getElementById('fileIn').click()">Record Video</button>
        <button class="btn btn-dark" onclick="showPage('homePage')">Back</button>
    </div>

    <div id="storagePage" class="page">
        <h2 style="font-family:'Oswald'">Saved Projects</h2>
        <div id="storageList"></div>
        <button class="btn btn-dark" onclick="showPage('homePage')">Main Menu</button>
    </div>

    <div id="editorPage" class="page">
        <div class="pill" id="status">TAP THE WALL TO START</div>
        
        <div class="viewport" id="viewport" onclick="handleTap(event)">
            <video id="vid" loop muted playsinline crossorigin="anonymous"></video>
            <canvas id="canv"></canvas>
            <div id="tapGuide" class="tap-instruction">ðŸ‘† TAP WALL HERE</div>
        </div>

        <div class="slider-container">
            <label style="font-size:0.8rem; font-weight:bold;">Match Sensitivity</label>
            <input type="range" id="toleranceSlider" min="10" max="150" value="40">
        </div>

        <div class="grid" id="editorGrid"></div>
        
        <div style="display:flex; gap:10px;">
            <button class="btn btn-orange" onclick="saveProject()">Save</button>
            <button class="btn btn-dark" onclick="stopAI()">Exit</button>
        </div>
    </div>

    <script>
        const colors = [
            {n:'Ultra Pure White', h:'#FFFFFF'}, {n:'Swiss Coffee', h:'#F1EFE0'},
            {n:'Polar Bear', h:'#F5F6F0'}, {n:'Slate Grey', h:'#708090'},
            {n:'Naval', h:'#202A44'}, {n:'Sage', h:'#778875'},
            {n:'Cinnamon', h:'#9E4825'}, {n:'Mustard', h:'#D8A728'},
            {n:'Terracotta', h:'#C46247'}, {n:'Teal', h:'#006D75'}
        ];

        let activeColor = null; 
        let targetWallColor = null; // Stores the specific RGB of the wall you tap
        let animID;
        const video = document.getElementById('vid');
        const canvas = document.getElementById('canv');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const toleranceSlider = document.getElementById('toleranceSlider');

        // --- NAVIGATION ---
        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function handleUpload(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = () => {
                let s = JSON.parse(localStorage.getItem('hd_pro_v2') || '[]');
                s.push({id: Date.now(), data: reader.result});
                localStorage.setItem('hd_pro_v2', JSON.stringify(s));
                openStorage();
            };
            reader.readAsDataURL(file);
        }

        function openStorage() {
            const list = document.getElementById('storageList');
            list.innerHTML = "";
            let s = JSON.parse(localStorage.getItem('hd_pro_v2') || '[]');
            s.forEach(item => {
                const d = document.createElement('div');
                d.style.background = "white"; d.style.padding = "10px"; d.style.marginBottom = "10px"; d.style.borderRadius="4px";
                d.innerHTML = `<video src="${item.data}" style="width:100%; border-radius:4px"></video>
                               <button class="btn btn-orange" style="margin-top:5px; padding:10px;" onclick="startAI('${item.data}')">OPEN PROJECT</button>`;
                list.appendChild(d);
            });
            showPage('storagePage');
        }

        // --- INIT COLORS ---
        function initColors() {
            const grid = document.getElementById('editorGrid');
            colors.forEach(c => {
                const d = document.createElement('div');
                d.className = 'swatch'; d.style.background = c.h;
                d.onclick = () => { 
                    activeColor = hexToRgb(c.h); 
                    document.querySelectorAll('.swatch').forEach(s => s.classList.remove('selected'));
                    d.classList.add('selected');
                };
                grid.appendChild(d);
            });
        }

        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : null;
        }

        // --- TOUCH TARGETING LOGIC ---
        function startAI(src) {
            video.src = src;
            activeColor = null; 
            targetWallColor = null;
            document.getElementById('status').innerText = "TAP THE WALL TO START";
            document.getElementById('tapGuide').style.opacity = "1";
            showPage('editorPage');
            video.play();
            video.onloadedmetadata = () => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                processLoop();
            };
        }

        function handleTap(e) {
            // Calculate tap position relative to video/canvas
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;

            // Sample the color at that pixel
            const pixel = ctx.getImageData(x, y, 1, 1).data;
            targetWallColor = { r: pixel[0], g: pixel[1], b: pixel[2] };

            document.getElementById('status').innerText = "TARGET LOCKED: SELECT COLOR";
            document.getElementById('tapGuide').style.opacity = "0";
        }

        function processLoop() {
            if (video.paused || video.ended) return;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const frame = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = frame.data;
            const tolerance = parseInt(toleranceSlider.value); // User adjustable sensitivity

            if (targetWallColor && activeColor) {
                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i], g = data[i+1], b = data[i+2];

                    // --- MATCHING ALGORITHM ---
                    // Calculate "Distance" between current pixel and the Tapped Wall Color
                    // If distance is small, it means this pixel is part of the wall
                    const dist = Math.sqrt(
                        (r - targetWallColor.r) ** 2 +
                        (g - targetWallColor.g) ** 2 +
                        (b - targetWallColor.b) ** 2
                    );

                    if (dist < tolerance) {
                        // Apply Paint (Multiply Blend for shadows)
                        data[i] = (r * activeColor.r) / 255;
                        data[i+1] = (g * activeColor.g) / 255;
                        data[i+2] = (b * activeColor.b) / 255;
                    }
                }
            } else if (!targetWallColor) {
                // Not targeted yet? Show a subtle "Scanning" tint to encourage tapping
                // (Optional visual cue)
            }

            ctx.putImageData(frame, 0, 0);
            animID = requestAnimationFrame(processLoop);
        }

        function stopAI() {
            cancelAnimationFrame(animID);
            video.pause();
            showPage('storagePage');
        }

        function saveProject() { alert("Project Saved!"); stopAI(); }

        initColors();
    </script>
</body>
</html>
