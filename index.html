<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Depot Pro Vision</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Oswald:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root { --hd-orange: #F96302; --hd-dark: #333333; --hd-light: #f5f5f5; }
        * { box-sizing: border-box; touch-action: manipulation; }
        body { margin: 0; font-family: 'Roboto', sans-serif; background: var(--hd-light); color: #333; text-align: center; }
        
        /* BRANDING */
        header { background: var(--hd-orange); padding: 12px; color: white; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); position: sticky; top: 0; z-index: 100; }
        .hd-square { background: var(--hd-orange); border: 2px solid white; color: white; font-family: 'Oswald', sans-serif; font-size: 0.7rem; font-weight: bold; padding: 3px 5px; line-height: 1; transform: skew(-10deg); }
        h1 { font-family: 'Oswald', sans-serif; margin: 0; font-size: 1.3rem; letter-spacing: 0.5px; text-transform: uppercase; }

        .page { display: none; max-width: 450px; margin: 0 auto; padding: 20px; min-height: 100vh; }
        .active { display: block; }

        /* BUTTONS */
        .btn { width: 100%; padding: 16px; border: none; border-radius: 4px; font-family: 'Oswald', sans-serif; font-size: 1.1rem; cursor: pointer; margin-bottom: 12px; text-transform: uppercase; transition: 0.2s; }
        .btn-orange { background: var(--hd-orange); color: white; }
        .btn-dark { background: var(--hd-dark); color: white; }
        .btn-save { background: #2ecc71; color: white; margin-top: 10px; }

        /* VIEWPORT & AI */
        .viewport { position: relative; width: 100%; background: black; border-radius: 8px; overflow: hidden; border: 4px solid var(--hd-orange); margin-bottom: 10px; }
        video { width: 100%; display: none; }
        canvas { width: 100%; display: block; }
        
        /* PULSE ANIMATION */
        .scanning-ring { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 60px; height: 60px; border: 3px solid white; border-radius: 50%; animation: pulse 1.5s infinite; pointer-events: none; }
        @keyframes pulse { 0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(2); opacity: 0; } }

        /* STORAGE */
        .list-card { background: white; padding: 15px; margin-bottom: 15px; border-left: 6px solid var(--hd-orange); text-align: left; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .video-preview { width: 100%; border-radius: 4px; background: #000; }

        /* COLOR GRID */
        .grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin: 15px 0; background: white; padding: 10px; border-radius: 8px; }
        .swatch { height: 40px; border-radius: 4px; cursor: pointer; border: 1px solid #ccc; transition: 0.2s; }
        .swatch.selected { border: 3px solid var(--hd-orange); transform: scale(1.1); box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        
        .status-bar { background: #333; color:white; padding: 8px 15px; border-radius: 4px; font-size: 0.8rem; margin-bottom: 10px; display: inline-block; font-family: 'Oswald'; letter-spacing: 1px; }
        .control-group { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; text-align: left; }
        input[type=range] { width: 100%; accent-color: var(--hd-orange); }
    </style>
</head>
<body>

    <header>
        <div class="hd-square">THE<br>HOME<br>DEPOT</div>
        <h1>Project Colorâ„¢</h1>
    </header>

    <div id="homePage" class="page active">
        <h2 style="font-family:'Oswald'; margin-top:40px;">Visualizer Tools</h2>
        <button class="btn btn-orange" onclick="showPage('uploadPage')">ðŸ“· Record New Room</button>
        <button class="btn btn-dark" onclick="renderStorage()">ðŸ“¦ View Saved Projects</button>
    </div>

    <div id="uploadPage" class="page">
        <h2 style="font-family:'Oswald'">Upload Capture</h2>
        <p>Record a 3-5 second clip of the wall you want to paint.</p>
        <input type="file" id="cameraInput" accept="video/*" capture="environment" style="display:none" onchange="handleFile(event)">
        <button class="btn btn-orange" onclick="document.getElementById('cameraInput').click()">Open Camera</button>
        <button class="btn btn-dark" onclick="showPage('homePage')">Cancel</button>
    </div>

    <div id="storagePage" class="page">
        <h2 style="font-family:'Oswald'">My Projects</h2>
        <div id="storageList"></div>
        <button class="btn btn-dark" onclick="showPage('homePage')">Back to Menu</button>
    </div>

    <div id="editorPage" class="page">
        <div class="status-bar" id="statusText">TAP THE WALL TO START</div>
        
        <div class="viewport" onclick="processTap(event)">
            <video id="vSource" loop muted playsinline crossorigin="anonymous"></video>
            <canvas id="cOutput"></canvas>
            <div id="tapPrompt" class="scanning-ring"></div>
            <div style="position:absolute; bottom:10px; right:10px; pointer-events:none;">
                <div class="hd-square">THE<br>HOME<br>DEPOT</div>
            </div>
        </div>

        <div class="control-group">
            <label style="font-weight:bold; font-size:0.75rem;">AI SENSITIVITY (Match Strength)</label>
            <input type="range" id="tolerance" min="5" max="100" value="35">
        </div>

        <div class="grid" id="paintGrid"></div>
        
        <button class="btn btn-save" onclick="downloadFrame()">ðŸ“¸ Download Design</button>
        <button class="btn btn-dark" onclick="exitEditor()">Close Editor</button>
    </div>

    <script>
        const paintColors = [
            {n:'Ultra Pure White', h:'#FFFFFF'}, {n:'Swiss Coffee', h:'#F1EFE0'},
            {n:'Slate Grey', h:'#708090'}, {n:'Naval Blue', h:'#202A44'},
            {n:'Sage Brush', h:'#778875'}, {n:'Cinnamon', h:'#9E4825'},
            {n:'Golden Honey', h:'#D8A728'}, {n:'Terra Cotta', h:'#C46247'},
            {n:'Deep Teal', h:'#006D75'}, {n:'Iron Mountain', h:'#333333'}
        ];

        let selectedRGB = null; 
        let wallHSL = null;
        let loopId;
        const video = document.getElementById('vSource');
        const canvas = document.getElementById('cOutput');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });

        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // --- STORAGE SYSTEM ---
        function handleFile(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = () => {
                let db = JSON.parse(localStorage.getItem('hd_pro_vFinal') || '[]');
                db.push({id: Date.now(), data: reader.result});
                localStorage.setItem('hd_pro_vFinal', JSON.stringify(db));
                renderStorage();
            };
            reader.readAsDataURL(file);
        }

        function renderStorage() {
            const list = document.getElementById('storageList');
            list.innerHTML = "";
            let db = JSON.parse(localStorage.getItem('hd_pro_vFinal') || '[]');
            if(db.length === 0) list.innerHTML = "<p>Your library is empty.</p>";
            db.forEach(item => {
                const card = document.createElement('div');
                card.className = "list-card";
                card.innerHTML = `
                    <strong>Project: ${new Date(item.id).toLocaleTimeString()}</strong>
                    <video src="${item.data}" class="video-preview"></video>
                    <button class="btn btn-orange" style="margin-top:10px; padding:10px;" onclick="launchEditor('${item.data}')">Open Visualizer</button>
                    <button style="color:#666; background:none; border:none; width:100%; cursor:pointer; font-size:0.8rem;" onclick="deleteItem(${item.id})">Remove Project</button>
                `;
                list.appendChild(card);
            });
            showPage('storagePage');
        }

        function deleteItem(id) {
            let db = JSON.parse(localStorage.getItem('hd_pro_vFinal') || '[]');
            localStorage.setItem('hd_pro_vFinal', JSON.stringify(db.filter(i => i.id !== id)));
            renderStorage();
        }

        // --- AI LOGIC ---
        function launchEditor(src) {
            video.src = src;
            wallHSL = null; selectedRGB = null;
            document.getElementById('statusText').innerText = "1. TAP THE WALL TO TARGET";
            document.getElementById('tapPrompt').style.display = 'block';
            showPage('editorPage');
            video.play();
            video.onloadedmetadata = () => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                runAI();
            };
        }

        function rgbToHsl(r, g, b) {
            r /= 255; g /= 255; b /= 255;
            const max = Math.max(r, g, b), min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;
            if (max === min) h = s = 0;
            else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                if (max === r) h = (g - b) / d + (g < b ? 6 : 0);
                else if (max === g) h = (b - r) / d + 2;
                else h = (r - g) / d + 4;
                h /= 6;
            }
            return [h * 360, s * 100, l * 100];
        }

        function processTap(e) {
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) * (canvas.width / rect.width);
            const y = (e.clientY - rect.top) * (canvas.height / rect.height);
            const p = ctx.getImageData(x, y, 1, 1).data;
            wallHSL = rgbToHsl(p[0], p[1], p[2]);
            document.getElementById('statusText').innerText = "2. PICK A COLOR BELOW";
            document.getElementById('tapPrompt').style.display = 'none';
        }

        function runAI() {
            if (video.paused || video.ended) return;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const frame = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = frame.data;
            const tol = parseInt(document.getElementById('tolerance').value);

            if (wallHSL && selectedRGB) {
                for (let i = 0; i < data.length; i += 4) {
                    const hsl = rgbToHsl(data[i], data[i+1], data[i+2]);
                    const hDiff = Math.abs(hsl[0] - wallHSL[0]);
                    const sDiff = Math.abs(hsl[1] - wallHSL[1]);
                    const lDiff = Math.abs(hsl[2] - wallHSL[2]);

                    if (hDiff < tol && sDiff < tol && lDiff < (tol * 1.5)) {
                        data[i] = (data[i] * selectedRGB.r) / 255;
                        data[i+1] = (data[i+1] * selectedRGB.g) / 255;
                        data[i+2] = (data[i+2] * selectedRGB.b) / 255;
                    }
                }
            }
            ctx.putImageData(frame, 0, 0);
            loopId = requestAnimationFrame(runAI);
        }

        // --- INTERFACE UTILS ---
        function buildPalette() {
            const grid = document.getElementById('paintGrid');
            paintColors.forEach(p => {
                const sw = document.createElement('div');
                sw.className = 'swatch'; sw.style.background = p.h;
                sw.onclick = () => {
                    selectedRGB = hexToRgb(p.h);
                    document.querySelectorAll('.swatch').forEach(s => s.classList.remove('selected'));
                    sw.classList.add('selected');
                    document.getElementById('statusText').innerText = "APPLIED: " + p.n.toUpperCase();
                };
                grid.appendChild(sw);
            });
        }

        function hexToRgb(hex) {
            const r = parseInt(hex.slice(1,3), 16), g = parseInt(hex.slice(3,5), 16), b = parseInt(hex.slice(5,7), 16);
            return {r, g, b};
        }

        function exitEditor() { cancelAnimationFrame(loopId); video.pause(); showPage('storagePage'); }

        function downloadFrame() {
            const link = document.createElement('a');
            link.download = 'my-home-depot-project.png';
            link.href = canvas.toDataURL();
            link.click();
        }

        buildPalette();
    </script>
</body>
</html>
