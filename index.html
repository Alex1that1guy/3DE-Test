<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Color - Home Depot Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Oswald:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root { --hd-orange: #F96302; --hd-grey: #444444; --hd-white: #FFFFFF; }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: #f5f5f5; color: #333; text-align: center; }
        
        /* BRANDING HEADER */
        header { 
            background: var(--hd-orange); 
            padding: 15px; 
            color: white; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.15); 
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        /* CSS-Only Home Depot Logo */
        .hd-logo-box {
            background: var(--hd-orange);
            color: white;
            font-family: 'Oswald', sans-serif;
            border: 2px solid white;
            padding: 2px 5px;
            font-size: 0.8rem;
            line-height: 0.9;
            transform: skew(-10deg);
            font-weight: bold;
            display: inline-block;
        }
        
        h1 { font-family: 'Oswald', sans-serif; margin: 0; text-transform: uppercase; font-size: 1.4rem; letter-spacing: 1px; }

        .page { display: none; width: 100%; max-width: 450px; margin: 0 auto; padding: 20px; min-height: 100vh; }
        .active { display: block; }
        
        /* UI BUTTONS */
        .btn { 
            width: 100%; padding: 18px; border: none; 
            font-family: 'Oswald', sans-serif; font-weight: bold; font-size: 1.1rem;
            cursor: pointer; margin-bottom: 15px; 
            text-transform: uppercase; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .btn-upload { background: var(--hd-orange); color: white; }
        .btn-storage { background: var(--hd-grey); color: white; }
        .btn-colors { background: white; color: var(--hd-orange); border: 2px solid var(--hd-orange); }
        .btn-back { background: #ddd; color: #333; margin-top: 20px; }

        /* SCANNER & VIDEO */
        .video-wrapper { 
            position: relative; width: 100%; 
            border: 5px solid var(--hd-orange); 
            overflow: hidden; background: #000; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); 
        }
        video { width: 100%; display: none; }
        canvas { width: 100%; display: block; }

        /* Watermark */
        .watermark {
            position: absolute; bottom: 10px; right: 10px;
            opacity: 0.7; transform: scale(0.8); pointer-events: none;
        }

        /* PALETTE */
        .color-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin: 20px 0; background: white; padding: 15px; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .swatch { height: 45px; border-radius: 2px; cursor: pointer; border: 1px solid #ccc; }
        .swatch.active { border: 3px solid var(--hd-orange); transform: scale(1.1); box-shadow: 0 0 10px rgba(0,0,0,0.2); }
        
        .status-bar { background: #333; color: white; padding: 10px; font-size: 0.9rem; margin-bottom: 10px; font-family: 'Oswald'; letter-spacing: 1px; }
        
        .list-card { background: white; padding: 15px; margin-bottom: 15px; border-left: 6px solid var(--hd-orange); text-align: left; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    </style>
</head>
<body>

    <header>
        <div class="hd-logo-box">THE<br>HOME<br>DEPOT</div>
        <h1>Project Color</h1>
    </header>

    <div id="homePage" class="page active">
        <h2 style="font-family: 'Oswald'; color:#333; margin-top:30px;">Start Your Project</h2>
        <p style="color:#666; margin-bottom:30px;">Visualize paint on your walls instantly.</p>
        
        <button class="btn btn-upload" onclick="showPage('instructionPage')">ðŸ“· Upload New Room</button>
        <button class="btn btn-storage" onclick="openStorage()">ðŸ“¦ My Projects</button>
        <button class="btn btn-colors" onclick="showPage('colorMenuPage')">ðŸŽ¨ Browse Colors</button>
    </div>

    <div id="instructionPage" class="page">
        <h2 style="font-family: 'Oswald';">Step 1: Capture</h2>
        <div style="background: white; padding: 20px; border: 1px solid #ccc; margin-bottom: 20px;">
            <p><strong>3-Second Scan:</strong></p>
            <p>Pan your camera slowly across the room. Ensure the walls are lit.</p>
        </div>
        <input type="file" id="camInput" accept="video/*" capture="environment" style="display:none" onchange="processUpload(event)">
        <button class="btn btn-upload" onclick="document.getElementById('camInput').click()">Start Recording</button>
        <button class="btn btn-back" onclick="showPage('homePage')">Back</button>
    </div>

    <div id="storagePage" class="page">
        <h2 style="font-family: 'Oswald';">Saved Projects</h2>
        <div id="storageList"></div>
        <button class="btn btn-back" onclick="showPage('homePage')">Main Menu</button>
    </div>

    <div id="colorMenuPage" class="page">
        <h2 style="font-family: 'Oswald';">BehrÂ® Palette</h2>
        <div class="color-grid" id="previewGrid"></div>
        <button class="btn btn-back" onclick="showPage('homePage')">Main Menu</button>
    </div>

    <div id="editPage" class="page">
        <div class="status-bar" id="statusText">AI SCANNING SURFACES...</div>
        
        <div class="video-wrapper">
            <video id="sourceVid" loop muted playsinline></video>
            <canvas id="editorCanvas"></canvas>
            <div class="watermark">
                <div class="hd-logo-box">THE<br>HOME<br>DEPOT</div>
            </div>
        </div>

        <div class="color-grid" id="editorGrid"></div>
        <button class="btn btn-upload" onclick="saveEdit()">Save Project</button>
        <button class="btn btn-back" onclick="stopEditor()">Cancel</button>
    </div>

    <script>
        // Home Depot / Behr Inspired Palette
        const appColors = [
            {h: '#F0F0F0', r: 240, g: 240, b: 240, n: 'Ultra Pure White'},
            {h: '#E3DAC9', r: 227, g: 218, b: 201, n: 'Antique White'},
            {h: '#A9A9A9', r: 169, g: 169, b: 169, n: 'Platinum'},
            {h: '#3B444B', r: 59, g: 68, b: 75, n: 'Slate Grey'},
            {h: '#005F6A', r: 0, g: 95, b: 106, n: 'Deep Sea Dive'},
            {h: '#D2691E', r: 210, g: 105, b: 30, n: 'Cinnamon'},
            {h: '#8A9A5B', r: 138, g: 154, b: 91, n: 'Sage Brush'},
            {h: '#708090', r: 112, g: 128, b: 144, n: 'Stormy Sky'},
            {h: '#B94E48', r: 185, g: 78, b: 72, n: 'Red Clay'},
            {h: '#DAA520', r: 218, g: 165, b: 32, n: 'Honey Gold'}
        ];

        let activeColor = null; 
        let animationId = null;
        const video = document.getElementById('sourceVid');
        const canvas = document.getElementById('editorCanvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });

        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // --- UPLOAD & STORAGE ---
        function processUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = () => {
                let storage = JSON.parse(localStorage.getItem('hd_pro_storage') || '[]');
                storage.push({ id: Date.now(), data: reader.result });
                localStorage.setItem('hd_pro_storage', JSON.stringify(storage));
                openStorage();
            };
            reader.readAsDataURL(file);
        }

        function openStorage() {
            const list = document.getElementById('storageList');
            list.innerHTML = "";
            let storage = JSON.parse(localStorage.getItem('hd_pro_storage') || '[]');
            storage.forEach(item => {
                const div = document.createElement('div');
                div.className = 'list-card';
                div.innerHTML = `<div style="font-weight:bold; margin-bottom:5px;">Project ${new Date(item.id).toLocaleDateString()}</div>
                                 <video src="${item.data}" style="width:100%; border-radius:4px; margin-bottom:10px;"></video>
                                 <button class="btn btn-upload" style="margin:0; padding:10px; font-size:0.9rem;" onclick="startScanner('${item.data}')">OPEN VISUALIZER</button>`;
                list.appendChild(div);
            });
            showPage('storagePage');
        }

        // --- PALETTE GENERATION ---
        function initColors() {
            const preview = document.getElementById('previewGrid');
            const editor = document.getElementById('editorGrid');
            appColors.forEach(c => {
                const div = document.createElement('div');
                div.className = 'swatch'; div.style.background = c.h;
                preview.appendChild(div.cloneNode(true));
                div.onclick = () => { 
                    activeColor = c; 
                    document.getElementById('statusText').innerText = "APPLYING: " + c.n.toUpperCase();
                };
                editor.appendChild(div);
            });
        }

        // --- STRONG AI ENGINE ---
        function startScanner(src) {
            video.src = src;
            activeColor = null; // Reset
            document.getElementById('statusText').innerText = "AI SCANNING SURFACE...";
            showPage('editPage');
            video.play();
            video.onloadedmetadata = () => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                requestAnimationFrame(aiLoop);
            };
        }

        function aiLoop() {
            if (video.paused || video.ended) return;

            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const frame = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = frame.data;

            // Pre-calculate pulse for the "Scanning" effect
            const pulse = (Math.sin(Date.now() / 150) + 1) / 2; // Fast pulse

            for (let i = 0; i < data.length; i += 4) {
                const r = data[i], g = data[i+1], b = data[i+2];

                // --- THE AI LOGIC ---
                // 1. Calculate Brightness (Luma)
                const luma = 0.299*r + 0.587*g + 0.114*b;
                
                // 2. Calculate Saturation (How "colorful" is it?)
                // White/Grey has very low difference between R, G, and B
                const max = Math.max(r, g, b);
                const min = Math.min(r, g, b);
                const range = max - min; 

                // --- THRESHOLDS ---
                // Brightness > 80: Catches shadows and dim corners
                // Range < 35: Catches off-white, eggshell, and cream (allows slight warm tints)
                if (luma > 80 && range < 35) {
                    
                    if (!activeColor) {
                        // MODE 1: SCANNING (Pulsing Orange Highlight)
                        // Only add tint, don't replace
                        data[i] = r + (249 - r) * 0.4 * pulse;   // R moves toward Orange
                        data[i+1] = g + (99 - g) * 0.4 * pulse;  // G moves toward Orange
                        data[i+2] = b * 0.5;                     // B gets reduced
                    } else {
                        // MODE 2: PAINTING (Multiply Blend)
                        // Math: (Original Pixel * New Color) / Intensity
                        // This preserves the shadows (luma) of the wall
                        data[i] = (r * activeColor.r) / 240;
                        data[i+1] = (g * activeColor.g) / 240;
                        data[i+2] = (b * activeColor.b) / 240;
                    }
                }
            }
            ctx.putImageData(frame, 0, 0);
            animationId = requestAnimationFrame(aiLoop);
        }

        function stopEditor() {
            cancelAnimationFrame(animationId);
            video.pause();
            showPage('storagePage');
        }

        function saveEdit() {
            alert("Project saved to account!");
            stopEditor();
        }

        initColors();
    </script>
</body>
</html>
