<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Depot Pro Vision v6</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Oswald:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root { --hd-orange: #F96302; --hd-dark: #222; --hd-light: #f4f4f4; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Roboto', sans-serif; background: var(--hd-light); color: #333; }
        
        header { background: var(--hd-orange); padding: 15px; color: white; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 10px rgba(0,0,0,0.2); position: sticky; top: 0; z-index: 1000; }
        .hd-square { background: var(--hd-orange); border: 2px solid white; color: white; font-family: 'Oswald', sans-serif; font-size: 0.7rem; font-weight: bold; padding: 4px 6px; line-height: 1; transform: skew(-10deg); }
        header h1 { font-family: 'Oswald', sans-serif; margin: 0; font-size: 1.2rem; text-transform: uppercase; }

        .page { display: none; max-width: 500px; margin: 0 auto; padding: 20px; }
        .active { display: block; }

        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .btn { width: 100%; padding: 16px; border: none; border-radius: 6px; font-family: 'Oswald', sans-serif; font-size: 1.1rem; cursor: pointer; text-transform: uppercase; transition: 0.2s; display: block; margin-bottom: 10px; text-decoration: none; text-align: center; }
        .btn-orange { background: var(--hd-orange); color: white; }
        .btn-dark { background: var(--hd-dark); color: white; }

        /* GALLERY SYSTEM */
        #gallery { display: grid; gap: 15px; }
        .project-item { background: white; border-radius: 10px; overflow: hidden; border: 1px solid #ddd; padding: 10px; }
        .thumb-nav { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }

        /* EDITOR */
        .viewport { position: relative; width: 100%; border-radius: 8px; overflow: hidden; background: #000; border: 3px solid var(--hd-dark); }
        canvas { width: 100%; display: block; }
        video { display: none; }
        .ai-status { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.8); color: #0f0; padding: 5px 10px; font-size: 0.7rem; border-radius: 4px; font-family: monospace; }

        /* COLOR SWATCHES */
        .swatch-box { display: flex; gap: 10px; overflow-x: auto; padding: 15px 0; }
        .swatch { min-width: 50px; height: 50px; border-radius: 50%; border: 3px solid white; cursor: pointer; flex-shrink: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .swatch.selected { border-color: var(--hd-orange); transform: scale(1.1); }
    </style>
</head>
<body>

<header>
    <div style="display:flex; align-items:center; gap:10px;">
        <div class="hd-square">THE<br>HOME<br>DEPOT</div>
        <h1>Pro Vision v6</h1>
    </div>
</header>

<div id="homePage" class="page active">
    <div class="card">
        <h2 style="font-family:'Oswald'; margin:0 0 10px 0;">New Room Project</h2>
        <p style="font-size: 0.9rem; color: #666;">Record your wall. Our AI handles the rest.</p>
        <input type="file" id="videoCapture" accept="video/*" capture="environment" style="display:none" onchange="processFile(event)">
        <button class="btn btn-orange" onclick="document.getElementById('videoCapture').click()">Start Recording</button>
    </div>
    <button class="btn btn-dark" onclick="openGallery()">üì¶ My Saved Projects</button>
</div>

<div id="galleryPage" class="page">
    <h2 style="font-family:'Oswald'">Project Library</h2>
    <div id="gallery"></div>
    <button class="btn btn-dark" style="margin-top:20px;" onclick="showPage('homePage')">Main Menu</button>
</div>

<div id="editorPage" class="page">
    <div class="viewport">
        <div class="ai-status" id="aiLabel">AI: STANDBY</div>
        <video id="vSource" loop muted playsinline></video>
        <canvas id="cOutput" onclick="targetWall(event)"></canvas>
    </div>
    
    <div style="margin:15px 0;">
        <label style="font-size: 0.7rem; font-weight: bold;">AI SENSITIVITY</label>
        <input type="range" id="sens" min="5" max="100" value="35" style="width:100%; accent-color:var(--hd-orange);">
    </div>

    <div class="swatch-box" id="palette"></div>
    
    <button class="btn btn-orange" onclick="downloadPhoto()">üì∏ Save To Camera Roll</button>
    <button class="btn btn-dark" onclick="closeEditor()">Back</button>
</div>

<script>
    const paintList = [
        {h:'#FFFFFF'}, {h:'#F1EFE0'}, {h:'#B0A99F'}, {h:'#202A44'},
        {h:'#778875'}, {h:'#C46247'}, {h:'#D8A728'}, {h:'#333333'}
    ];

    let db;
    let selectedPaint = null;
    let wallTarget = null;
    let loop;
    const v = document.getElementById('vSource');
    const c = document.getElementById('cOutput');
    const ctx = c.getContext('2d', {willReadFrequently: true});

    // --- 1. PRO STORAGE (INDEXED DB) ---
    const request = indexedDB.open("HD_ProVision_DB", 1);
    request.onupgradeneeded = (e) => {
        db = e.target.result;
        db.createObjectStore("videos", { keyPath: "id", autoIncrement: true });
    };
    request.onsuccess = (e) => db = e.target.result;

    function processFile(e) {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = () => {
            const tx = db.transaction("videos", "readwrite");
            tx.objectStore("videos").add({ data: reader.result, date: new Date().toLocaleString() });
            tx.oncomplete = () => openGallery();
        };
        reader.readAsDataURL(file);
    }

    function openGallery() {
        showPage('galleryPage');
        const container = document.getElementById('gallery');
        container.innerHTML = "Loading...";
        const tx = db.transaction("videos", "readonly");
        const store = tx.objectStore("videos");
        const req = store.getAll();
        req.onsuccess = () => {
            container.innerHTML = req.result.length ? "" : "No projects saved.";
            req.result.reverse().forEach(item => {
                const div = document.createElement('div');
                div.className = "project-item";
                div.innerHTML = `
                    <div style="font-size:0.8rem; margin-bottom:8px;"><b>Project:</b> ${item.date}</div>
                    <video src="${item.data}" style="width:100%; border-radius:4px;"></video>
                    <div class="thumb-nav">
                        <button class="btn btn-orange" style="width:70%; margin:0; padding:10px;" onclick="launchEditor('${item.data}')">Analyze</button>
                        <button onclick="deleteProj(${item.id})" style="border:none; background:none; font-size:1.5rem; cursor:pointer;">üóëÔ∏è</button>
                    </div>
                `;
                container.appendChild(div);
            });
        };
    }

    function deleteProj(id) {
        const tx = db.transaction("videos", "readwrite");
        tx.objectStore("videos").delete(id);
        tx.oncomplete = () => openGallery();
    }

    // --- 2. STRONGER AI ENGINE ---
    function launchEditor(src) {
        v.src = src;
        wallTarget = null;
        selectedPaint = null;
        showPage('editorPage');
        v.play();
        v.onloadedmetadata = () => {
            c.width = v.videoWidth;
            c.height = v.videoHeight;
            startAI();
        };
    }

    function targetWall(e) {
        const rect = c.getBoundingClientRect();
        const x = (e.clientX - rect.left) * (c.width / rect.width);
        const y = (e.clientY - rect.top) * (c.height / rect.height);
        const p = ctx.getImageData(x, y, 1, 1).data;
        wallTarget = {r: p[0], g: p[1], b: p[2]};
        document.getElementById('aiLabel').innerText = "AI: LOCKED";
        document.getElementById('aiLabel').style.color = "#0f0";
    }

    function startAI() {
        if (v.paused || v.ended) return;
        ctx.drawImage(v, 0, 0, c.width, c.height);
        
        if (wallTarget && selectedPaint) {
            const frame = ctx.getImageData(0, 0, c.width, c.height);
            const d = frame.data;
            const sens = document.getElementById('sens').value;

            for (let i = 0; i < d.length; i += 4) {
                const r = d[i], g = d[i+1], b = d[i+2];

                // Delta-E "Perception" Logic
                const diff = Math.sqrt(Math.pow(r-wallTarget.r,2)+Math.pow(g-wallTarget.g,2)+Math.pow(b-wallTarget.b,2));

                if (diff < sens) {
                    // Multiply Blend: This preserves the wall's texture and natural shadows
                    d[i] = (r * selectedPaint.r) / 255;
                    d[i+1] = (g * selectedPaint.g) / 255;
                    d[i+2] = (b * selectedPaint.b) / 255;
                }
            }
            ctx.putImageData(frame, 0, 0);
        }
        loop = requestAnimationFrame(startAI);
    }

    // --- 3. UI HELPERS ---
    function showPage(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function closeEditor() {
        cancelAnimationFrame(loop);
        v.pause();
        openGallery();
    }

    function downloadPhoto() {
        const link = document.createElement('a');
        link.download = "HD_Pro_Design.png";
        link.href = c.toDataURL();
        link.click();
    }

    // Init Palette
    const palette = document.getElementById('palette');
    paintList.forEach(p => {
        const s = document.createElement('div');
        s.className = 'swatch';
        s.style.background = p.h;
        s.onclick = () => {
            const hex = p.h;
            selectedPaint = {
                r: parseInt(hex.slice(1,3), 16),
                g: parseInt(hex.slice(3,5), 16),
                b: parseInt(hex.slice(5,7), 16)
            };
            document.querySelectorAll('.swatch').forEach(el => el.classList.remove('selected'));
            s.classList.add('selected');
        };
        palette.appendChild(s);
    });
</script>
</body>
</html>
