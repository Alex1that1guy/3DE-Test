<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wall Paint Visualization</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Oswald:wght@700&display=swap" rel="stylesheet">
    <style>
        :root { --hd-orange: #F96302; --hd-grey: #333333; --hd-white: #FFFFFF; }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: #f4f4f4; color: #333; text-align: center; }
        
        /* THEME HEADER */
        header { background: var(--hd-orange); padding: 15px; color: white; font-family: 'Oswald', sans-serif; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        .page { display: none; width: 100%; max-width: 450px; margin: 0 auto; padding: 20px; min-height: 100vh; }
        .active { display: block; }
        
        /* BUTTONS */
        .btn { width: 100%; padding: 18px; border: none; font-family: 'Oswald', sans-serif; font-weight: bold; cursor: pointer; margin-bottom: 15px; font-size: 1.1rem; transition: 0.2s; text-transform: uppercase; }
        .btn-upload { background: var(--hd-orange); color: white; }
        .btn-storage { background: var(--hd-grey); color: white; }
        .btn-colors { background: #666; color: white; }
        .btn-back { background: #ddd; color: #333; margin-top: 20px; }

        /* VIDEO & AI CANVAS */
        .video-container { position: relative; width: 100%; border: 4px solid var(--hd-orange); overflow: hidden; background: #000; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        video { width: 100%; display: none; }
        canvas { width: 100%; display: block; }

        /* PULSE EFFECT */
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(249, 99, 2, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(249, 99, 2, 0); }
            100% { box-shadow: 0 0 0 0 rgba(249, 99, 2, 0); }
        }
        .scanning { animation: pulse 1.5s infinite; }
        
        .color-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin: 20px 0; background: white; padding: 15px; border-radius: 4px; box-shadow: inset 0 2px 5px rgba(0,0,0,0.1); }
        .swatch { height: 45px; border-radius: 2px; cursor: pointer; border: 1px solid #ccc; }
        .swatch.active { border: 3px solid var(--hd-orange); transform: scale(1.1); }
        
        .status-pill { display: inline-block; padding: 8px 20px; background: var(--hd-grey); border-radius: 4px; font-size: 0.9rem; margin-bottom: 15px; color: var(--hd-orange); font-weight: bold; border: 1px solid var(--hd-orange); }
        .list-card { background: white; padding: 15px; margin-bottom: 15px; border-left: 8px solid var(--hd-orange); box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: left; }
    </style>
</head>
<body>

    <header><h1>The Wall Lab</h1></header>

    <div id="homePage" class="page active">
        <h2 style="font-family: 'Oswald';">Project Tools</h2>
        <button class="btn btn-upload" onclick="showPage('instructionPage')">Upload New Room</button>
        <button class="btn btn-storage" onclick="openStorage()">Video Storage</button>
        <button class="btn btn-colors" onclick="showPage('colorMenuPage')">Explore Colors</button>
    </div>

    <div id="instructionPage" class="page">
        <h2 style="font-family: 'Oswald';">Step 1: Capture</h2>
        <div style="background: white; padding: 20px; border: 1px solid #ccc; margin-bottom: 20px;">
            <p>To use our AI scanner, record a <strong>3-second video</strong> of your room.</p>
            <p style="font-size: 0.8rem; color: #666;">Tip: Use bright, even lighting for best results.</p>
        </div>
        <input type="file" id="camInput" accept="video/*" capture="environment" style="display:none" onchange="processUpload(event)">
        <button class="btn btn-upload" onclick="document.getElementById('camInput').click()">Record Video</button>
        <button class="btn btn-back" onclick="showPage('homePage')">Back</button>
    </div>

    <div id="storagePage" class="page">
        <h2 style="font-family: 'Oswald';">Saved Clips</h2>
        <div id="storageList"></div>
        <button class="btn btn-back" onclick="showPage('homePage')">Main Menu</button>
    </div>

    <div id="colorMenuPage" class="page">
        <h2 style="font-family: 'Oswald';">10 Pro Finishes</h2>
        <div class="color-grid" id="previewGrid"></div>
        <button class="btn btn-back" onclick="showPage('homePage')">Main Menu</button>
    </div>

    <div id="editPage" class="page">
        <div class="status-pill" id="statusPill">AI INITIALIZING...</div>
        <div class="video-container" id="scannerRing">
            <video id="sourceVid" loop muted playsinline></video>
            <canvas id="editorCanvas"></canvas>
        </div>
        <div class="color-grid" id="editorGrid"></div>
        <button class="btn btn-upload" onclick="saveEdit()">Finish & Save</button>
        <button class="btn btn-back" onclick="stopEditor()">Cancel</button>
    </div>

    <script>
        const appColors = [
            {h: '#F8F9F9', r: 248, g: 249, b: 249, n: 'Swiss White'},
            {h: '#E5D3B3', r: 229, g: 211, b: 179, n: 'Natural Tan'},
            {h: '#A9A9A9', r: 169, g: 169, b: 169, n: 'Industrial Grey'},
            {h: '#2B547E', r: 43, g: 84, b: 126, n: 'Navy Force'},
            {h: '#4E5B31', r: 78, g: 91, b: 49, n: 'Forest Edge'},
            {h: '#8B4513', r: 139, g: 69, b: 19, n: 'Cedar Wood'},
            {h: '#6F2DA8', r: 111, g: 45, b: 168, n: 'Royal Purple'},
            {h: '#D4AF37', r: 212, g: 175, b: 55, n: 'Harvest Gold'},
            {h: '#B22222', r: 178, g: 34, b: 34, n: 'Brick Red'},
            {h: '#008080', r: 0, g: 128, b: 128, n: 'Deep Teal'}
        ];

        let activeColor = null; 
        let currentFrameId = null;
        const video = document.getElementById('sourceVid');
        const canvas = document.getElementById('editorCanvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });

        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function processUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = () => {
                let storage = JSON.parse(localStorage.getItem('hd_storage') || '[]');
                storage.push({ id: Date.now(), data: reader.result });
                localStorage.setItem('hd_storage', JSON.stringify(storage));
                openStorage();
            };
            reader.readAsDataURL(file);
        }

        function openStorage() {
            const list = document.getElementById('storageList');
            list.innerHTML = "";
            let storage = JSON.parse(localStorage.getItem('hd_storage') || '[]');
            storage.forEach(item => {
                const div = document.createElement('div');
                div.className = 'list-card';
                div.innerHTML = `<strong>Room Capture ${new Date(item.id).toLocaleTimeString()}</strong>
                                 <video src="${item.data}" style="width:100%; border-radius:4px; margin:10px 0;"></video>
                                 <button class="btn btn-upload" style="margin-bottom:0" onclick="startAI('${item.data}')">Analyze & Paint</button>`;
                list.appendChild(div);
            });
            showPage('storagePage');
        }

        function initColors() {
            const preview = document.getElementById('previewGrid');
            const editor = document.getElementById('editorGrid');
            appColors.forEach(c => {
                const div = document.createElement('div');
                div.className = 'swatch'; div.style.background = c.h;
                preview.appendChild(div.cloneNode(true));
                div.onclick = () => { activeColor = c; };
                editor.appendChild(div);
            });
        }

        function startAI(src) {
            video.src = src;
            activeColor = null;
            document.getElementById('statusPill').innerText = "AI SCANNING SURFACE...";
            document.getElementById('scannerRing').classList.add('scanning');
            showPage('editPage');
            video.play();
            video.onloadedmetadata = () => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                requestAnimationFrame(aiRenderLoop);
            };
        }

        function aiRenderLoop() {
            if (video.paused || video.ended) return;

            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const frame = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = frame.data;

            // STRONGER AI: Wider Luminous Target Range
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i], g = data[i+1], b = data[i+2];
                
                // Detect neutral, high-luma pixels (white walls)
                // Lowered threshold to 150 to catch 'off-white' and shadows on white walls
                const brightness = (r + g + b) / 3;
                const isNeutral = Math.abs(r - g) < 25 && Math.abs(g - b) < 25;

                if (brightness > 150 && isNeutral) {
                    if (!activeColor) {
                        // PULSING HIGHLIGHT: Orange Scan Tint
                        const pulse = (Math.sin(Date.now() / 200) + 1) / 2;
                        data[i] = r + (249 - r) * 0.3 * pulse;
                        data[i+1] = g + (99 - g) * 0.3 * pulse;
                        data[i+2] = b + (2 - b) * 0.3 * pulse;
                    } else {
                        // SMART REPLACEMENT: Blend with lighting
                        document.getElementById('statusPill').innerText = "VIRTUAL COAT APPLIED";
                        data[i] = (r * activeColor.r) / 240;
                        data[i+1] = (g * activeColor.g) / 240;
                        data[i+2] = (b * activeColor.b) / 240;
                    }
                }
            }
            ctx.putImageData(frame, 0, 0);
            currentFrameId = requestAnimationFrame(aiRenderLoop);
        }

        function stopEditor() {
            cancelAnimationFrame(currentFrameId);
            video.pause();
            document.getElementById('scannerRing').classList.remove('scanning');
            showPage('storagePage');
        }

        function saveEdit() {
            alert("Project logic finalized and stored.");
            stopEditor();
        }

        initColors();
    </script>
</body>
</html>
